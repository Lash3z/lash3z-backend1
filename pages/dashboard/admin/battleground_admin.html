<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battleground — Admin</title>
<meta http-equiv="Cache-Control" content="no-store"/>
<style>
  :root{
    --bg:#060b0d;--ink:#eaf7ff;--muted:#9fd0d6;--line:rgba(0,255,255,.18);
    --panel:#0b1417;--btn:#0f1720;--accent:#ffb42d;--danger:#61222a;--ok:#12d48a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:1280px;margin:18px auto;padding:0 16px}
  h1{margin:0 0 10px;color:#00ffff;text-shadow:0 0 16px #00ffff55}
  .sub{color:var(--muted);font-size:12px;margin-bottom:10px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff;font-size:12px}
  .btn{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:var(--btn);color:#eaf7ff;font-weight:800;cursor:pointer}
  .btn.ok{background:#23392e;border-color:#2ba87d}
  .btn.warn{background:#2b2211;border-color:#a37a2b}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.small{padding:8px 10px}
  input,select{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:#eaf7ff;padding:10px}
  .card{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#0a1418,#0a1216);padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .gridMain{display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:start}
  /* Games (left) */
  .games{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto;padding-right:4px}
  .gItem{display:grid;grid-template-columns:64px 1fr auto auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:10px}
  .thumb{width:64px;height:64px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#061015}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .gTitle{font-weight:900}
  .gProv{font-size:12px;color:#9fd0d6}
  .gPath{font-size:11px;color:#7fbcc7}
  .gSelected{outline:2px solid #00ffff99;box-shadow:0 0 0 3px rgba(0,255,255,.18) inset}
  /* Matches (right) */
  .matches{display:flex;flex-direction:column;gap:12px;max-height:70vh;overflow:auto}
  .mRow{border:1px solid var(--line);border-radius:14px;background:#0b1418;padding:12px;
        display:grid;grid-template-columns:1fr auto 1fr auto auto;gap:14px;align-items:center}
  .slot{display:grid;grid-template-columns:64px 1fr;gap:10px;align-items:center}
  .slot .gTitle{display:flex;gap:6px;align-items:center}
  .trophy{display:inline-flex;width:24px;height:24px;border-radius:6px;background:#24311a;border:1px solid rgba(0,255,0,.25);
          align-items:center;justify-content:center;font-size:14px}
  .vs{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0d171c;color:#bfe}
  .actBox{display:flex;gap:8px}
  .mMeta{font-size:12px;color:#9fd0d6}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .tip{font-size:12px;color:#9fd0d6}
</style>
</head>
<body>
<div class="wrap">
  <h1>Battleground — Admin</h1>
  <div class="sub">Tip: use **asset paths** for covers (e.g. <code>/assets/slot_images/duck_hunters.png</code>). These persist across refreshes. The upload box only previews and is not persisted.</div>

  <div class="card row" style="justify-content:space-between">
    <div class="row">
      <span class="pill">Asset Path</span>
      <input id="assetPath" value="/assets/slot_images/duck_hunters.png" style="min-width:320px">
      <button id="chooseFiles" class="btn">Choose Files</button>
      <input id="gameFile" type="file" accept="image/*" multiple style="display:none">
      <span class="pill">Provider</span>
      <input id="gameProvider" placeholder="E.G. HACKSAW" style="width:180px">
      <label class="pill"><input id="autoPair" type="checkbox" checked style="vertical-align:middle;margin-right:6px">Auto-pair after import</label>
    </div>
    <div class="row">
      <button id="btnPublish" class="btn ok">Publish</button>
      <button id="btnResetAll" class="btn warn">Reset All (Matchups)</button>
      <button id="btnClearWinners" class="btn">Clear Winners</button>
      <span id="stamp" class="pill">Not published</span>
    </div>
  </div>

  <div class="gridMain">
    <!-- LEFT: Games -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Games</span>
        </div>
        <div class="row">
          <button id="selAll" class="btn small">Select All</button>
          <button id="selClear" class="btn small">Clear Selection</button>
          <button id="pairSelected" class="btn small">+ Add Match (pair selected)</button>
        </div>
      </div>
      <div id="games" class="games"></div>
    </div>

    <!-- RIGHT: Matches -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Matchups & Live Scores</span>
        </div>
        <div class="tip">Set a winner → you’ll see a trophy on that side.</div>
      </div>
      <div id="matches" class="matches"></div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const $ = s => document.querySelector(s);
  const el = (t,cls)=>{ const n=document.createElement(t); if(cls) n.className=cls; return n; };
  const sget=(k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
  const sset=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };
  const up=s=>(s||"").toString().trim().toUpperCase();

  const K_BUILDER = "bg:builder:battleground";  // primary builder key
  const K_LIVE    = "battleground:live";        // live mirror for unified live

  // State
  let builder = sget(K_BUILDER) || { games:[], matches:[], lastUpdated:0 };
  let selectedIds = new Set();

  // ---------- helpers
  function trophySVG(){
    return `<svg viewBox="0 0 24 24" width="16" height="16" fill="#c9f57e" aria-hidden="true">
      <path d="M7 4h10v3a5 5 0 0 1-4 4.9V14h2a1 1 0 1 1 0 2H9a1 1 0 0 1 0-2h2v-2.1A5 5 0 0 1 7 7V4zm-2 1a2 2 0 0 0 0 4h1V5H5zm12 0v4h1a2 2 0 1 0 0-4h-1z"/>
    </svg>`;
  }
  function imgTag(src){ return src ? `<img src="${src}" alt="">` : ""; }

  // ---------- painting
  function paintGames(){
    const host = $("#games"); host.innerHTML = "";
    if(!builder.games.length){
      host.innerHTML = `<div class="pill">No games yet. Click <b>Choose Files</b> and select multiple.</div>`;
      return;
    }
    builder.games.forEach(g=>{
      const row = el("div","gItem"+(selectedIds.has(g.id)?" gSelected":""));
      row.innerHTML = `
        <div class="thumb">${imgTag(g.img)}</div>
        <div>
          <div class="gTitle">${up(g.title||"")}</div>
          <div class="gProv">${g.provider||""}</div>
          <div class="gPath">${g.img||""}</div>
        </div>
        <div><button class="btn small selBtn">${selectedIds.has(g.id)?"Unselect":"Select"}</button></div>
        <div><button class="btn small danger delBtn">Delete</button></div>
      `;
      row.querySelector(".selBtn").onclick = ()=>{
        if(selectedIds.has(g.id)) selectedIds.delete(g.id); else selectedIds.add(g.id);
        paintGames();
      };
      row.querySelector(".delBtn").onclick = ()=>{
        if(!confirm(`Delete game "${g.title}"?`)) return;
        // remove from games
        builder.games = builder.games.filter(x=>x.id!==g.id);
        // remove from matches where used
        builder.matches = builder.matches.filter(m=> m.leftId!==g.id && m.rightId!==g.id );
        selectedIds.delete(g.id);
        save();
        paintGames(); paintMatches();
      };
      host.appendChild(row);
    });
  }

  function paintMatches(){
    const host = $("#matches"); host.innerHTML = "";
    if(!builder.matches.length){
      host.innerHTML = `<div class="pill">No matchups yet. Select two games and click <b>+ Add Match (pair selected)</b> or enable <b>Auto-pair after import</b>.</div>`;
      return;
    }
    builder.matches.forEach((m,idx)=>{
      const L = builder.games.find(g=>g.id===m.leftId) || {title:"—",img:"",provider:""};
      const R = builder.games.find(g=>g.id===m.rightId)|| {title:"—",img:"",provider:""};
      const row = el("div","mRow");
      row.innerHTML = `
        <div class="slot">
          <div class="thumb">${imgTag(L.img)}</div>
          <div>
            <div class="gTitle">${up(L.title)} ${m.winner==='L'?'<span class="trophy" title="Winner">'+trophySVG()+'</span>':''}</div>
            <div class="gProv">${L.provider||""}</div>
          </div>
        </div>
        <div class="vs">VS</div>
        <div class="slot">
          <div class="thumb">${imgTag(R.img)}</div>
          <div>
            <div class="gTitle">${up(R.title)} ${m.winner==='R'?'<span class="trophy" title="Winner">'+trophySVG()+'</span>':''}</div>
            <div class="gProv">${R.provider||""}</div>
          </div>
        </div>
        <div class="actBox">
          <button class="btn small setL">Set Winner ←</button>
          <button class="btn small setR">→ Set Winner</button>
        </div>
        <div class="actBox">
          <button class="btn small danger del">Delete</button>
        </div>
      `;
      row.querySelector(".setL").onclick = ()=>{ m.winner='L'; save(); paintMatches(); };
      row.querySelector(".setR").onclick = ()=>{ m.winner='R'; save(); paintMatches(); };
      row.querySelector(".del").onclick  = ()=>{
        if(!confirm("Delete this matchup?")) return;
        builder.matches.splice(idx,1); save(); paintMatches();
      };
      host.appendChild(row);
    });
  }

  // ---------- core actions
  function save(){
    sset(K_BUILDER, builder);
  }

  function publish(){
    builder.lastUpdated = Date.now();
    save();
    // also push a simple live mirror for your unified live page
    const live = { lastUpdated: builder.lastUpdated, matches: builder.matches.map(m=>{
      const L = builder.games.find(g=>g.id===m.leftId)||{};
      const R = builder.games.find(g=>g.id===m.rightId)||{};
      return {
        left:{ name: up(L.title||''), game: L.provider||'', img:L.img||'' },
        right:{ name: up(R.title||''), game: R.provider||'', img:R.img||'' },
        winner: m.winner||null
      };
    })};
    sset(K_LIVE, live);
    $("#stamp").textContent = "Published @ "+new Date(builder.lastUpdated).toLocaleTimeString();
  }

  function pairSelected(){
    const ids=[...selectedIds];
    if(ids.length<2){ alert("Select at least two games to pair."); return; }
    for(let i=0;i<ids.length;i+=2){
      const L=ids[i], R=ids[i+1];
      if(L && R){
        builder.matches.push({ id:"m_"+Math.random().toString(36).slice(2,8), leftId:L, rightId:R, winner:null });
      }
    }
    // keep them selected (no change needed)
    save(); paintMatches();
  }

  // ---------- file import (multi) — auto-add + optional auto-pair
  $("#chooseFiles").addEventListener("click", ()=> $("#gameFile").click());

  $("#gameFile").addEventListener("change",(e)=>{
    const files = [...e.target.files];
    if(!files.length) return;
    const provDefault = ($("#gameProvider").value||"").trim();

    const justAdded = [];
    files.forEach(f=>{
      const base = f.name.replace(/\.[a-z0-9]+$/i,''); // strip extension
      const title = base.replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
      const id = "g_"+Math.random().toString(36).slice(2,8);
      builder.games.push({
        id,
        title,
        provider: provDefault,
        img: `/assets/slot_images/${base}.png`
      });
      justAdded.push(id);
      selectedIds.add(id);
    });

    // Optional auto-pair newly added
    if($("#autoPair").checked){
      for(let i=0;i<justAdded.length;i+=2){
        const L=justAdded[i], R=justAdded[i+1];
        if(L && R){
          builder.matches.push({ id:"m_"+Math.random().toString(36).slice(2,8), leftId:L, rightId:R, winner:null });
        }
      }
    }

    save();
    paintGames(); paintMatches();
    // reset input so selecting same files again still triggers
    e.target.value="";
  });

  // ---------- controls
  $("#selAll").onclick   = ()=>{ builder.games.forEach(g=>selectedIds.add(g.id)); paintGames(); };
  $("#selClear").onclick = ()=>{ selectedIds.clear(); paintGames(); };
  $("#pairSelected").onclick = pairSelected;

  $("#btnPublish").onclick = publish;
  $("#btnClearWinners").onclick = ()=>{ builder.matches.forEach(m=>m.winner=null); save(); paintMatches(); };
  $("#btnResetAll").onclick = ()=>{
    if(!confirm("Clear ALL matchups? Games list stays as-is.")) return;
    builder.matches = []; save(); paintMatches();
  };

  // ---------- boot
  if(builder.lastUpdated){ $("#stamp").textContent = "Published @ "+new Date(builder.lastUpdated).toLocaleTimeString(); }
  paintGames(); paintMatches();
})();
</script>
</body>
</html>
