<!DOCTYPE html>
<html lang="en" data-admin="ready">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store"/>
<title>L3Z — Hub</title>
<style>
  :root{
    --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6;
    --line:rgba(0,255,255,.18); --teal:#00ffff; --gold:#ffb42d;
    --ok:#12d48a; --bad:#e25a6f; --ink2:#cfffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  h1{margin:16px 0 8px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
  h2{margin:0 0 10px;font-size:16px;color:var(--ink)}
  .wrap{max-width:1300px;margin:0 auto;padding:0 16px 48px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .panel{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:220px}
  .full{grid-column:1 / -1}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:var(--ink2)}
  input,select,textarea{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:var(--ink);padding:8px}
  textarea{width:100%;min-height:80px}
  button{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#0f1720;color:var(--ink);font-weight:800;cursor:pointer}
  button.ok{background:#103d30;border-color:#1fa37b}
  button.danger{background:#2b1116;border-color:#7e2a3c}
  button.warn{background:#231b0f;border-color:#8c6926}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px;text-align:left;font-size:13px}
  .tbl th{color:var(--muted)}
  .right{margin-left:auto}
  .hint{color:var(--muted);font-size:12px}
  .mini{font-size:12px;color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#081318;color:#bfe}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--line);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none;z-index:9999}
  .toast.on{opacity:1;transform:translateY(0)}
  .muted{color:var(--muted)}
  .nowrap{white-space:nowrap}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>

<div class="wrap">
  <h1>Hub</h1>

  <div class="grid" id="grid">

    <!-- RAFFLES (read-only + local draw) -->
    <div class="panel">
      <h2>Raffles</h2>
      <div class="row">
        <input id="rfId" placeholder="RAFFLE ID" style="width:160px">
        <button id="rfRefresh">Refresh</button>
        <button id="rfDraw">Draw Winner (local)</button>
        <span id="rfMsg" class="pill">Ready</span>
      </div>
      <div class="hr"></div>
      <div class="mini">Entries</div>
      <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px">
        <table class="tbl" id="rfTbl">
          <thead><tr><th>#</th><th>User</th><th>Time</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mini" style="margin-top:6px">Tip: Use <span class="badge">/api/admin/raffles/:id/entries</span> for admin reads.</div>
    </div>

    <!-- VIP WALLET -->
    <div class="panel">
      <h2>VIP — Wallet Adjust</h2>
      <div class="row">
        <input id="vipUser" placeholder="USERNAME" style="width:160px;text-transform:uppercase">
        <input id="vipAmt" type="number" step="1" placeholder="+/- LBX" style="width:120px">
        <input id="vipWhy" placeholder="Reason (e.g., LUCKY7)" style="min-width:200px">
        <button id="vipApply" class="ok">Apply</button>
        <span id="vipMsg" class="pill">Ready</span>
      </div>
      <div class="hr"></div>
      <div class="mini">Posts to <code>/api/wallet/adjust</code>. (Admin login or bypass required.)</div>
    </div>

    <!-- PROMO CODES: CREATE -->
    <div class="panel">
      <h2>Promo Codes — Create</h2>
      <div class="row">
        <label class="mini muted">Amount</label>
        <select id="pcAmount">
          <option>5</option><option>10</option><option>15</option>
          <option>20</option><option>25</option><option>30</option>
        </select>

        <label class="mini muted">Max Redemptions</label>
        <input id="pcMax" type="number" value="1" min="1" style="width:110px">

        <label class="mini muted">Per-User Limit</label>
        <input id="pcPerUser" type="number" value="1" min="1" style="width:110px">

        <label class="mini muted">Expires</label>
        <input id="pcExpiry" type="datetime-local">

        <label class="mini muted">Notes</label>
        <input id="pcNotes" placeholder="Twitter drop / Discord" style="min-width:180px">

        <button id="pcCreate" class="ok">Create Code</button>
        <span id="pcMsg" class="pill">Ready</span>
      </div>
      <div class="hr"></div>
      <div class="mini">Endpoint: <code>/api/admin/promo/create</code></div>
      <div class="mini" id="pcCreateOut"></div>
    </div>

    <!-- PROMO CODES: BATCH -->
    <div class="panel">
      <h2>Promo Codes — Batch Generate</h2>
      <div class="row">
        <label class="mini muted">Prefix</label>
        <input id="pcPrefix" placeholder="L3Z-AUG" style="width:140px">

        <label class="mini muted">Amount</label>
        <select id="pcAmount2">
          <option>5</option><option>10</option><option>15</option>
          <option>20</option><option>25</option><option>30</option>
        </select>

        <label class="mini muted">Count</label>
        <input id="pcCount" type="number" value="50" min="1" max="5000" style="width:110px">

        <label class="mini muted">Max Redemptions</label>
        <input id="pcMax2" type="number" value="1" min="1" style="width:110px">

        <label class="mini muted">Per-User Limit</label>
        <input id="pcPerUser2" type="number" value="1" min="1" style="width:110px">

        <label class="mini muted">Expires</label>
        <input id="pcExpiry2" type="datetime-local">

        <label class="mini muted">Notes</label>
        <input id="pcNotes2" placeholder="Campaign tag" style="min-width:160px">

        <button id="pcBatch" class="warn">Generate Batch</button>
        <span id="pcBatchMsg" class="pill">Ready</span>
      </div>
      <div class="hr"></div>
      <div class="mini">Endpoint: <code>/api/admin/promo/generate</code></div>
      <pre id="pcBatchOut" class="mini" style="white-space:pre-wrap"></pre>
    </div>

    <!-- PROMO CODES: LIST / DISABLE -->
    <div class="panel full">
      <h2>Promo Codes — List</h2>
      <div class="row">
        <select id="pcFilter">
          <option value="all">All</option>
          <option value="1">Active</option>
          <option value="0">Inactive</option>
        </select>
        <button id="pcRefresh">Refresh</button>
        <span id="pcListMsg" class="pill">Ready</span>
        <span class="right mini muted">Use this to monitor redemptions in real time on stream.</span>
      </div>
      <div class="hr"></div>
      <div style="max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px">
        <table class="tbl" id="pcTbl">
          <thead>
            <tr>
              <th>Code</th>
              <th>Amount</th>
              <th>Redeemed</th>
              <th>Per-User</th>
              <th>Active</th>
              <th>Expires</th>
              <th>Notes</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- PROMO: REDEEM TESTER -->
    <div class="panel">
      <h2>Redeem LBX (tester)</h2>
      <div class="row">
        <input id="rdmCode" placeholder="Enter promo code" style="flex:1;min-width:220px">
        <button id="rdmGo">Redeem</button>
        <span id="rdmMsg" class="pill">Ready</span>
      </div>
      <div class="hr"></div>
      <div class="mini">Calls <code>/api/promo/redeem</code> using your current <code>viewer</code> cookie.</div>
      <div class="mini" id="rdmOut"></div>
    </div>

    <!-- UTILITIES -->
    <div class="panel">
      <h2>Utilities</h2>
      <div class="row">
        <button id="btnPing">Ping API</button>
        <span id="utilMsg" class="pill">Ready</span>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast">Saved.</div>

<!-- Minimal API helper -->
<script>
(function(){
  "use strict";
  if (window.api && typeof window.api.get==="function") return;
  function isJson(res){ return (res.headers.get("content-type")||"").indexOf("application/json")>-1; }
  async function readBody(res){ try{ return isJson(res) ? await res.json() : await res.text(); }catch(_){ return null; } }
  function err(res,body){ var e=new Error((body&&body.error)||("HTTP "+res.status)); e.status=res.status; e.body=body; return e; }
  async function core(path,opts){
    var res=await fetch(path,{credentials:"include",cache:"no-store",headers:(opts&&opts.headers)||{},method:(opts&&opts.method)||"GET",body:opts&&opts.body});
    var body=await readBody(res);
    if(!res.ok || (body&&body.ok===false)) throw err(res,body);
    return body==null?{ok:true}:body;
  }
  window.api={
    get:function(p,o){ return core(p,o||{}); },
    post:function(p,b,o){ o=o||{}; o.method="POST"; o.headers=Object.assign({"Content-Type":"application/json"},o.headers||{}); o.body=JSON.stringify(b||{}); return core(p,o); }
  };
})();
</script>

<!-- Page logic (admin hub) -->
<script>
(function(){
  "use strict";
  var $ = function(s,r){ return (r||document).querySelector(s); };
  var $$ = function(s,r){ return Array.from((r||document).querySelectorAll(s)); };
  var toast = $("#toast");
  function showToast(t){ toast.textContent=t||"Saved."; toast.classList.add("on"); setTimeout(function(){ toast.classList.remove("on"); }, 1400); }
  function up(s){ return String(s||"").trim().toUpperCase(); }
  function pill(el,txt,ok){ el.textContent=txt; el.style.background = ok ? "#103d30" : "#0f1720"; el.style.borderColor = ok ? "#1fa37b" : "var(--line)"; }
  function fmtDate(d){ if(!d) return "—"; try{ return new Date(d).toLocaleString(); }catch(_){ return "—"; } }

  /* ---------- RAFFLES (read-only + local draw) ---------- */
  var rfId=$("#rfId"), rfRefresh=$("#rfRefresh"), rfDraw=$("#rfDraw"), rfMsg=$("#rfMsg"), rfTbl=$("#rfTbl tbody");
  function renderEntries(tbody,rows){
    tbody.innerHTML = (rows||[]).map(function(r,i){
      var ts = r.ts ? new Date(r.ts).toLocaleString() : (r.createdAt?fmtDate(r.createdAt):"—");
      var name = up(r.user||r.username||"");
      return '<tr><td>'+(i+1)+'</td><td>'+name+'</td><td>'+ts+'</td></tr>';
    }).join("") || '<tr><td colspan="3" class="mini">No entries</td></tr>';
  }
  function getRaffleEntriesById(id){
    if(!id){ pill(rfMsg,"Missing ID"); return; }
    rfMsg.textContent="Loading…";
    api.get("/api/admin/raffles/"+encodeURIComponent(up(id))+"/entries").then(function(j){
      renderEntries(rfTbl, j.entries||[]);
      pill(rfMsg,"OK",true);
    }).catch(function(e){
      console.warn(e);
      renderEntries(rfTbl, []);
      pill(rfMsg,"Load failed");
    });
  }
  rfRefresh.addEventListener("click", function(){ getRaffleEntriesById(rfId.value); });
  rfDraw.addEventListener("click", function(){
    var names = $$("#rfTbl tr td:nth-child(2)").map(function(td){ return td.textContent.trim(); });
    if(!names.length){ pill(rfMsg,"No entries"); return; }
    var pick = names[Math.floor(Math.random()*names.length)];
    showToast("Winner: "+pick);
  });

  /* ---------- VIP WALLET ---------- */
  var vipUser=$("#vipUser"), vipAmt=$("#vipAmt"), vipWhy=$("#vipWhy"), vipApply=$("#vipApply"), vipMsg=$("#vipMsg");
  vipApply.addEventListener("click", function(){
    var user=up(vipUser.value), amt=Number(vipAmt.value||0), why=(vipWhy.value||"ADJUSTMENT").toString();
    if(!user || !amt){ pill(vipMsg,"Need USER + AMOUNT"); return; }
    vipApply.disabled=true; vipMsg.textContent="Submitting…";
    api.post("/api/wallet/adjust", { username:user, delta:amt, reason:why }).then(function(r){
      pill(vipMsg,"OK",true);
      showToast("Wallet updated");
      vipAmt.value=""; vipWhy.value="";
    }).catch(function(e){
      pill(vipMsg, (e.body&&e.body.error) || "Failed");
    }).finally(function(){ vipApply.disabled=false; });
  });

  /* ---------- PROMO: CREATE ---------- */
  var pcMsg=$("#pcMsg"), pcCreate=$("#pcCreate"), pcCreateOut=$("#pcCreateOut");
  pcCreate.addEventListener("click", function(){
    var body = {
      amount: Number($("#pcAmount").value),
      maxRedemptions: Number($("#pcMax").value||1),
      perUserLimit: Number($("#pcPerUser").value||1),
      expiresAt: $("#pcExpiry").value ? new Date($("#pcExpiry").value).toISOString() : null,
      notes: $("#pcNotes").value || ""
    };
    pcCreate.disabled = true; pcMsg.textContent = "Creating…";
    api.post("/api/admin/promo/create", body).then(function(r){
      pill(pcMsg,"Created",true);
      pcCreateOut.textContent = "Code: " + r.code;
      showToast("Promo created");
      refreshPromoList();
    }).catch(function(e){
      pill(pcMsg, (e.body&&e.body.error)||"Error");
    }).finally(function(){ pcCreate.disabled=false; });
  });

  /* ---------- PROMO: BATCH ---------- */
  var pcBatch=$("#pcBatch"), pcBatchMsg=$("#pcBatchMsg"), pcBatchOut=$("#pcBatchOut");
  pcBatch.addEventListener("click", function(){
    var body = {
      prefix: $("#pcPrefix").value || "L3Z",
      amount: Number($("#pcAmount2").value),
      count: Number($("#pcCount").value||1),
      maxRedemptions: Number($("#pcMax2").value||1),
      perUserLimit: Number($("#pcPerUser2").value||1),
      expiresAt: $("#pcExpiry2").value ? new Date($("#pcExpiry2").value).toISOString() : null,
      notes: $("#pcNotes2").value || ""
    };
    pcBatch.disabled=true; pcBatchMsg.textContent="Generating…";
    api.post("/api/admin/promo/generate", body).then(function(r){
      pill(pcBatchMsg,"OK",true);
      var sample = (r.sample||[]).join("\n");
      pcBatchOut.textContent = "Generated: " + r.generated + (sample?("\nSample:\n"+sample):"");
      showToast("Batch ready");
      refreshPromoList();
    }).catch(function(e){
      pill(pcBatchMsg,(e.body&&e.body.error)||"Error");
    }).finally(function(){ pcBatch.disabled=false; });
  });

  /* ---------- PROMO: LIST / DISABLE ---------- */
  var pcTblBody=$("#pcTbl tbody"), pcListMsg=$("#pcListMsg"), pcRefresh=$("#pcRefresh"), pcFilter=$("#pcFilter");
  function renderPromoTable(items){
    pcTblBody.innerHTML = (items||[]).map(function(p){
      var red = Number(p.redeemedCount||0) + " / " + Number(p.maxRedemptions||0);
      var act = p.active ? '<span class="badge">YES</span>' : '<span class="badge" style="background:#241018;border-color:#7e2a3c;color:#fbb">NO</span>';
      var exp = p.expiresAt ? fmtDate(p.expiresAt) : "—";
      var btn = p.active ? ('<button class="danger btnDisable" data-code="'+p.code+'">Disable</button>') : '';
      return '<tr>'+
        '<td class="nowrap">'+p.code+'</td>'+
        '<td>'+Number(p.amount||0)+'</td>'+
        '<td>'+red+'</td>'+
        '<td>'+Number(p.perUserLimit||1)+'</td>'+
        '<td>'+act+'</td>'+
        '<td>'+exp+'</td>'+
        '<td>'+(p.notes||'')+'</td>'+
        '<td>'+btn+'</td>'+
      '</tr>';
    }).join("") || '<tr><td colspan="8" class="mini">No promo codes found.</td></tr>';

    // wire disable buttons
    $$(".btnDisable", pcTblBody).forEach(function(b){
      b.addEventListener("click", function(){
        var code = this.getAttribute("data-code");
        if (!code) return;
        this.disabled = true;
        api.post("/api/admin/promo/disable", { code }).then(function(){
          showToast("Disabled: "+code);
          refreshPromoList();
        }).catch(function(e){
          alert("Disable failed: " + ((e.body&&e.body.error)||"Error"));
        }).finally(()=>{ /* noop; refreshed anyway */});
      });
    });
  }
  function refreshPromoList(){
    pcListMsg.textContent = "Loading…";
    var f = pcFilter.value;
    var url = (f==="all") ? "/api/admin/promo/list" : ("/api/admin/promo/list?active="+encodeURIComponent(f));
    api.get(url).then(function(r){
      renderPromoTable(r.items||[]);
      pill(pcListMsg,"OK",true);
    }).catch(function(e){
      console.warn(e);
      renderPromoTable([]);
      pill(pcListMsg,"Load failed");
    });
  }
  pcRefresh.addEventListener("click", refreshPromoList);
  pcFilter.addEventListener("change", refreshPromoList);

  /* ---------- PROMO: REDEEM TEST ---------- */
  var rdmGo=$("#rdmGo"), rdmCode=$("#rdmCode"), rdmMsg=$("#rdmMsg"), rdmOut=$("#rdmOut");
  rdmGo.addEventListener("click", function(){
    var code = (rdmCode.value||"").trim();
    if (!code){ pill(rdmMsg,"Enter a code"); return; }
    rdmGo.disabled=true; rdmMsg.textContent="Redeeming…";
    api.post("/api/promo/redeem",{ code }).then(function(r){
      pill(rdmMsg,"OK",true);
      rdmOut.textContent = "+"+r.added+" LBX added. New balance: "+(r.balance!=null?r.balance:"(see wallet)");
      showToast("Redeemed");
      rdmCode.value="";
    }).catch(function(e){
      pill(rdmMsg, (e.body&&e.body.error)||"Failed");
    }).finally(function(){ rdmGo.disabled=false; });
  });

  /* ---------- Utilities ---------- */
  var utilMsg=$("#utilMsg");
  $("#btnPing").addEventListener("click", function(){
    utilMsg.textContent="Pinging…";
    api.get("/api/health").then(function(){ pill(utilMsg,"OK",true); showToast("API OK"); })
      .catch(function(){ pill(utilMsg,"Ping failed"); });
  });

  // initial load
  refreshPromoList();
})();
</script>
</body>
</html>
