<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets — Unified</title>
<style>
:root{
  --bg:#061014;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;
  --line:rgba(0,255,255,.18);--teal:#00ffff;--gold:#ffb42d;--ok:#12d48a;--bad:#e25a6f;
  --sun:#ffeb9c; /* soft yellow */
}
*{box-sizing:border-box}
html,body{margin:0;background:#031015 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1720;color:#cfffff;cursor:pointer}
.tab.on{border-color:#00ffff88;box-shadow:0 0 14px #00ffff33}
.sectionTitle{font-weight:900;margin:10px 0 8px}

/* Player card (top-right) */
.player{
  display:flex;gap:10px;align-items:center;justify-content:flex-end;flex:1;
}
.badge{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;background:#0e1820;padding:8px 10px}
.ava{
  width:32px;height:32px;border-radius:50%;
  background:radial-gradient(60% 60% at 30% 30%, #1e3440, #0a141a);
  display:grid;place-items:center;border:1px solid var(--line);font-weight:900;color:#cfffff
}
.name{font-weight:900}
.balance{font-weight:900;color:#baffea}
.linkbtn{border:1px solid var(--line);border-radius:999px;background:#0f1720;color:#cfffff;padding:6px 10px;cursor:pointer}

/* H2H */
.h2hList{display:flex;flex-direction:column;gap:12px}
.h2h{border:1px solid var(--line);background:#0c161b;border-radius:12px;padding:10px}
.h2hHead{display:grid;grid-template-columns:1fr 40px 1fr;align-items:center;margin-bottom:8px}
.h2hHead .name{font-weight:900}
.h2hHead .vs{color:#9fe;text-align:center;font-weight:900}
.pickRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
.pick{
  display:grid;align-items:center;gap:8px;
  border:1px solid var(--line);background:#0e1820;border-radius:12px;
  padding:10px 12px;cursor:pointer;font-weight:800;transition:box-shadow .15s;
}
.pick:hover{box-shadow:0 0 0 2px rgba(0,255,255,.18) inset}
.pick .label{color:var(--sun);font-weight:900;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pick .odds{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#bff}
.pickL{grid-template-columns:auto 1fr;text-align:left}
.pickR{grid-template-columns:1fr auto;text-align:right}

/* Markets */
.mkts{display:flex;flex-direction:column;gap:12px}
.mkt{border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:10px}
.mTop{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
.mBtns{display:flex;flex-wrap:wrap;gap:8px}
.sel{border:1px solid var(--line);background:#0e1820;color:var(--sun);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:900;letter-spacing:.2px}
.sel:hover{box-shadow:0 0 0 2px rgba(0,255,255,.2) inset}

/* Slip */
.slip{position:sticky;top:16px;border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px}
.slip h3{margin:0 0 8px}
.small{font-size:12px;color:var(--muted)}
.ctrlRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.lbl{font-weight:900;color:#bfe}
.btn{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#0f1720;color:#eaf7ff;font-weight:800;cursor:pointer}
.btn.ok{background:#103d30;border-color:#1fa37b}
.btn.warn{background:#231b0f;border-color:#8c6926}
.btn.danger{background:#2b1116;border-color:#7e2a3c}
.inp{border:1px solid var(--line);border-radius:10px;background:#0c1519;color:#eaf7ff;padding:8px}
.slList{display:flex;flex-direction:column;gap:8px;margin:8px 0}
.ticket{border:1px solid var(--line);border-radius:10px;background:#0e1820;padding:8px}
.ticket .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
.ticket .odds{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#bff}
.ticket .stk{width:90px}

/* Bonus Hunt */
.guessBox{display:grid;grid-template-columns:1fr 110px;gap:8px;margin:6px 0}
.guessBox input{width:100%}

/* Drawer: My Bets */
.drawer{
  position:fixed;right:0;top:0;bottom:0;width:420px;background:#0a1418;border-left:1px solid var(--line);
  transform:translateX(100%);transition:transform .2s;z-index:9999;display:flex;flex-direction:column
}
.drawer.on{transform:translateX(0)}
.dHead{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
.dBody{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.betCard{border:1px solid var(--line);border-radius:10px;background:#0e1820;padding:10px}
.betCard .top{display:flex;justify-content:space-between;margin-bottom:6px}
.kv{display:flex;gap:6px;align-items:center}
</style>
</head>
<body>
  <!-- USER HEADER -->
<div class="userbar" id="userBar">
  <div class="ub-left">
    <span class="ub-hello">Hello,</span>
    <span id="ubName" class="ub-name">Guest</span>
  </div>
  <div class="ub-right">
    <span class="ub-badge">LBX <b id="ubBal">0</b></span>
  </div>
</div>

<style>
  .userbar{
    max-width:1100px; margin:12px auto 8px; padding:8px 12px;
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid rgba(255,255,255,.10); border-radius:12px;
    background:rgba(0,0,0,.25); backdrop-filter: blur(6px);
  }
  .ub-hello{ font-size:12px; color:#9fd0d6; margin-right:6px }
  .ub-name{ font-weight:900; color:#ffe39a }
  .ub-badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-weight:800;
    background:#2a2310; color:#ffe39a; border:1px solid #8c6926;
  }
  @media (max-width:520px){
    .userbar{ margin:8px 8px 4px; }
  }
</style>

<script>
/* Top userbar: populate name + LBX from API (fallback to local) */
(function(){
  "use strict";
  const $  = s => document.querySelector(s);
  const up = s => String(s||"").trim().toUpperCase();
  const sget = (k,def=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(_){ return def; } };

  function pickUser(){
    const qp = new URLSearchParams(location.search).get("viewer");
    if (qp && qp.trim()) return up(qp);
    const sess = sget("l3z:session");
    if (sess && sess.user) return up(sess.user);
    const prof = sget("l3z:user");
    if (prof && prof.username) return up(prof.username);
    const legacy = localStorage.getItem("user:username");
    if (legacy) return up(legacy);
    const last = sget("lash3z_last_user");
    if (last) return up(last);
    return "";
  }

  async function loadMe() {
    const name = pickUser() || "GUEST";
    $("#ubName").textContent = name;

    try{
      let lbx = null;

      const meRes = await fetch("/api/me", { credentials:"include", cache:"no-store" });
      if (meRes.ok) {
        const me = await meRes.json();
        if (me && me.user && typeof me.user.lbx === "number") lbx = me.user.lbx;
      }
      if (lbx === null) {
        const w1 = await fetch("/api/wallet/balance", { credentials:"include", cache:"no-store" });
        if (w1.ok) { const j = await w1.json(); if (typeof j.balance === "number") lbx = j.balance; }
      }
      if (lbx === null) {
        const w2 = await fetch("/api/wallet/me?viewer="+encodeURIComponent(name), { credentials:"include", cache:"no-store" });
        if (w2.ok) { const j = await w2.json(); if (j && j.wallet && typeof j.wallet.balance === "number") lbx = j.wallet.balance; }
      }

      if (lbx == null) throw 0;
      $("#ubBal").textContent = Math.floor(lbx);
      return;
    }catch(_){}

    const w = sget("lbx:wallet:"+name) || { balance: 0 };
    $("#ubBal").textContent = Math.floor(Number(w.balance||0));
  }

  window.addEventListener("storage", (e)=>{
    if(["l3z:session","l3z:user","user:username","lash3z_last_user"].includes(e.key)) loadMe();
  });

  loadMe();
})();
</script>

<div class="wrap">

  <div class="row" style="justify-content:space-between">
    <div class="row">
      <h1>Bets</h1>
      <span id="pub" class="pill">—</span>
    </div>

    <!-- Player Card -->
    <div class="player">
      <div class="badge">
        <div id="ava" class="ava">?</div>
        <div>
          <div id="pname" class="name">Guest</div>
          <div class="small">ID: <span id="pid">—</span></div>
        </div>
      </div>
      <div class="badge">
        <div class="small">Balance</div>
        <div class="balance"><span id="pbal">0</span> LBX</div>
      </div>
      <button id="btnMyBets" class="linkbtn">My Bets</button>
      <button id="btnSwitch" class="linkbtn">Switch name</button>
    </div>
  </div>

  <div class="row" style="justify-content:flex-start;margin:8px 0 12px">
    <div class="tabs">
      <button class="tab on" data-mode="battleground">Battleground</button>
      <button class="tab" data-mode="pvp">PVP</button>
      <button class="tab" data-mode="bonus">Bonus Hunt</button>
    </div>
  </div>

  <div class="grid">
    <div id="leftCol" class="card" style="min-height:200px"></div>

    <!-- slip -->
    <div class="slip">
      <h3>Your Bet Slip</h3>
      <div class="ctrlRow" style="margin-bottom:6px">
        <label><input type="radio" name="mode" value="single" checked> Single</label>
        <label><input type="radio" name="mode" value="multi"> Multi</label>
      </div>
      <div class="ctrlRow small"><span>Tap a selection to add it here.</span></div>

      <div id="slList" class="slList"></div>

      <div id="multiBox" class="ctrlRow" style="display:none;margin:6px 0">
        <span class="lbl">Multi Stake (LBX)</span>
        <input id="multiStake" class="inp" type="number" step="1" min="0" value="10" style="width:110px">
      </div>

      <div class="ctrlRow" style="justify-content:space-between">
        <div>
          <div class="small">Total Stake (LBX)</div>
          <div id="sumStake" class="lbl">0</div>
        </div>
        <div>
          <div class="small">Potential Return (LBX)</div>
          <div id="sumReturn" class="lbl">0</div>
        </div>
      </div>

      <div class="ctrlRow" style="margin-top:10px">
        <button id="btnPlace" class="btn ok">Place</button>
        <button id="btnClear" class="btn danger">Clear</button>
      </div>

      <div class="small" style="margin-top:10px">
        LBX stakes are used for Battleground & PVP. Bonus Hunt guesses are prize-based (no stake).
      </div>
    </div>
  </div>
</div>

<!-- My Bets drawer -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="dHead">
    <div style="font-weight:900">My Bets</div>
    <button id="btnCloseDrawer" class="linkbtn">Close</button>
  </div>
  <div id="betsBody" class="dBody"></div>
</div>

<script>
(function(){
  "use strict";
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const sget = k=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null;}catch(_){return null;} };
  const sset = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const esc = s=> String(s==null?'':s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const K_UNI='sb:markets:unified';
  const K_PRO='player:profile';
  const K_BETS=(id)=>'sb:bets:'+id;

  let mode='battleground';
  let data=sget(K_UNI) || {lastUpdated:0, sections:{battleground:{h2h:[],overall:[]}, pvp:{h2h:[],overall:[]}, bonus:{overall:[]}}};

  /* ------------ Player/Profile ------------- */
  async function getSessionAndBalance(){
    try{
      const me = await fetch('/api/me', {credentials:'include',cache:'no-store'});
      if(me.ok){
        const j = await me.json();
        const base = {
          userId: j?.user?.id || j?.userId || j?.id || '',
          username: j?.user?.username || j?.username || j?.name || 'Player',
          lbx: (typeof j?.user?.lbx === 'number') ? j.user.lbx : undefined
        };
        if (base.lbx === undefined) {
          const w = await fetch('/api/wallet/balance', {credentials:'include',cache:'no-store'});
          if (w.ok) { const b = await w.json(); base.lbx = Number(b.balance)||0; }
        }
        if (base.lbx === undefined) {
          const w2 = await fetch('/api/wallet/me', {credentials:'include',cache:'no-store'});
          if (w2.ok) { const b = await w2.json(); base.lbx = Number(b?.wallet?.balance)||0; }
        }
        if (base.userId || base.username) return { userId: base.userId, username: base.username, lbx: Number(base.lbx||0) };
      }
    }catch(_){}

    try{
      const r=await fetch('/api/auth/session',{credentials:'include',cache:'no-store'});
      if(r.ok){
        const j=await r.json();
        const base = { userId:j.userId||j.id||'', username:j.username||j.name||'Player', lbx:+(j.lbx||j.balance) };
        if (!Number.isFinite(base.lbx)) {
          const w = await fetch('/api/wallet/balance', {credentials:'include',cache:'no-store'});
          if (w.ok) { const b=await w.json(); base.lbx = Number(b.balance)||0; }
        }
        return base;
      }
    }catch(_){}
    return null;
  }

  function makeGuest(){
    const url = new URL(location.href);
    const qUser = (url.searchParams.get('user')||url.searchParams.get('u')||'').trim();
    const qBal  = url.searchParams.get('lbx');
    const id = 'G'+Math.random().toString(36).slice(2,8).toUpperCase();
    const username = qUser || ('Guest_'+id.slice(-4));
    const lbx = (qBal!=null && !isNaN(+qBal)) ? Math.max(0,+qBal) : 0;
    return {userId:id, username, lbx};
  }

  async function ensurePlayer(){
    let pro = sget(K_PRO);
    if(!pro){
      const s = await getSessionAndBalance();
      pro = s || makeGuest();
      sset(K_PRO, pro);
    }else{
      const url = new URL(location.href);
      const qUser = (url.searchParams.get('user')||url.searchParams.get('u')||'').trim();
      const qBal  = url.searchParams.get('lbx');
      if(qUser){ pro.username=qUser; }
      if(qBal!=null && !isNaN(+qBal)){ pro.lbx=Math.max(0,+qBal); }
      sset(K_PRO,pro);
    }
    try{
      const payload = {page:'bets', userId:pro.userId, ts:Date.now()};
      fetch('/api/track/visit', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify(payload),
        keepalive:true,
        credentials:'include',
        cache:'no-store'
      }).catch(()=>{});
    }catch(_){}
    return pro;
  }

  let player = {userId:'',username:'',lbx:0};
  const pname=$('#pname'), pid=$('#pid'), pbal=$('#pbal'), ava=$('#ava');
  const ubName=$('#ubName'), ubBal=$('#ubBal');

  function initials(name){
    const t=String(name||'').trim();
    if(!t) return '?';
    const parts=t.split(/\s+/);
    return (parts[0][0]||'').toUpperCase() + (parts[1]?.[0]||'').toUpperCase();
  }
  function refreshPlayerUI(){
    pname.textContent = player.username || 'Player';
    pid.textContent   = player.userId || '—';
    pbal.textContent  = (player.lbx||0).toFixed(0);
    ava.textContent   = initials(player.username);
    if (ubName) ubName.textContent = player.username || 'GUEST';
    if (ubBal)  ubBal.textContent  = (player.lbx||0).toFixed(0);
  }

  /* --- balance sync: keeps player card in step with header --- */
  async function fetchServerBalance(){
    try{
      const r1 = await fetch('/api/wallet/balance',{credentials:'include',cache:'no-store'});
      if(r1.ok){ const j = await r1.json(); if(typeof j.balance === 'number') return j.balance; }
    }catch(_){}
    try{
      const me = await fetch('/api/me',{credentials:'include',cache:'no-store'});
      if(me.ok){ const j = await me.json(); if(j?.user && typeof j.user.lbx === 'number') return j.user.lbx; }
    }catch(_){}
    try{
      const r2 = await fetch('/api/wallet/me',{credentials:'include',cache:'no-store'});
      if(r2.ok){ const j = await r2.json(); if(j?.wallet && typeof j.wallet.balance === 'number') return j.wallet.balance; }
    }catch(_){}
    return null;
  }
  async function syncBalance(){
    let b = await fetchServerBalance();
    if(b == null && ubBal){
      const n = Number(String(ubBal.textContent).replace(/[^\d.-]/g,''));
      if(Number.isFinite(n)) b = n;
    }
    if(b != null){
      player.lbx = Math.max(0, Math.floor(b));
      sset(K_PRO, player);
      refreshPlayerUI();
    }
  }

  document.getElementById('btnSwitch').addEventListener('click',()=>{
    const n = prompt('New display name:', player.username||'');
    if(!n) return;
    player.username = n.trim();
    sset(K_PRO, player);
    refreshPlayerUI();
  });

  /* ------------ Drawer: My Bets ------------- */
  const drawer=$('#drawer'), betsBody=$('#betsBody');
  document.getElementById('btnMyBets').addEventListener('click',()=>{ paintBets(); drawer.classList.add('on'); drawer.setAttribute('aria-hidden','false'); });
  document.getElementById('btnCloseDrawer').addEventListener('click',()=>{ drawer.classList.remove('on'); drawer.setAttribute('aria-hidden','true'); });

  function getBets(){ return sget(K_BETS(player.userId))||[]; }
  function putBets(list){ sset(K_BETS(player.userId), list); }
  function paintBets(){
    const list=getBets();
    betsBody.innerHTML='';
    if(!list.length){ betsBody.innerHTML='<div class="small">No bets yet.</div>'; return; }
    list.slice().reverse().forEach(b=>{
      const div=document.createElement('div'); div.className='betCard';
      div.innerHTML =
        '<div class="top"><div class="kv"><b>'+esc(b.mode.toUpperCase())+'</b></div><div class="small">'+new Date(b.ts).toLocaleString()+'</div></div>'+
        '<div class="row" style="justify-content:space-between">'+
          '<div class="kv"><span class="small">Stake</span><b>'+Number(b.stake).toFixed(2)+'</b></div>'+
          '<div class="kv"><span class="small">Potential</span><b>'+Number(b.potential).toFixed(2)+'</b></div>'+
          '<div class="kv"><span class="small">Status</span><b>'+(b.status||'Pending')+'</b></div>'+
        '</div>'+
        '<div class="small" style="margin-top:6px">'+ b.legs.map(l=>esc(l.label)+' ('+Number(l.odds).toFixed(2)+')').join('<br>') +'</div>';
      betsBody.appendChild(div);
    });
  }

  /* ------------ Markets / Bonus ------------- */
  const pub=$('#pub'), left=$('#leftCol');
  function setTab(newMode){ mode=newMode; $$('.tab').forEach(t=> t.classList.toggle('on', t.dataset.mode===mode)); paintPage(); }

  function addPick(p){
    if(slip.items.some(x=>x.key===p.key)) return; // de-dupe exact same leg
    p.stake = 10;
    slip.items.push(p);
    paintSlip(); recalc();
  }

  function paintPage(){
    data = sget(K_UNI) || data;
    pub.textContent = data.lastUpdated ? ('Published @ '+ new Date(data.lastUpdated).toLocaleString()) : 'Not published';
    left.innerHTML='';
    if(mode==='bonus'){ paintBonus(); return; }

    const sec = data.sections?.[mode] || {h2h:[],overall:[]};

    const h2hWrap=document.createElement('div'); h2hWrap.className='card'; h2hWrap.style.marginBottom='12px';
    const head=document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
    head.innerHTML='<div class="sectionTitle">Head-to-Head</div><span class="pill">'+(sec.h2h?.length||0)+' matchups</span>';
    h2hWrap.appendChild(head);

    const list=document.createElement('div'); list.className='h2hList';
    if(sec.h2h && sec.h2h.length){
      sec.h2h.forEach((m, idx)=>{
        const safeId = m.matchId ?? m.id ?? ('H'+idx); // <- UNIQUE even if data lacks matchId

        const card=document.createElement('div'); card.className='h2h';
        const hd=document.createElement('div'); hd.className='h2hHead';
        hd.innerHTML='<div class="name">'+esc(m.leftTitle||'LEFT')+'</div><div class="vs">VS</div><div class="name" style="text-align:right">'+esc(m.rightTitle||'RIGHT')+'</div>';
        card.appendChild(hd);

        const picks=document.createElement('div'); picks.className='pickRow';

        const L=document.createElement('button'); L.className='pick pickL'; L.type='button';
        L.innerHTML='<span class="odds">'+esc(m.leftOdds??2)+'</span><span class="label">'+esc(m.leftTitle||'LEFT')+'</span>';
        L.addEventListener('click',()=> addPick({
          key:'h2h:'+safeId+':L',
          label:(m.leftTitle||'LEFT')+' — H2H',
          odds:+(m.leftOdds||2),
          kind:'H2H',
          meta:{matchId:safeId,side:'LEFT'}
        }));

        const R=document.createElement('button'); R.className='pick pickR'; R.type='button';
        R.innerHTML='<span class="label">'+esc(m.rightTitle||'RIGHT')+'</span><span class="odds">'+esc(m.rightOdds??2)+'</span>';
        R.addEventListener('click',()=> addPick({
          key:'h2h:'+safeId+':R',
          label:(m.rightTitle||'RIGHT')+' — H2H',
          odds:+(m.rightOdds||2),
          kind:'H2H',
          meta:{matchId:safeId,side:'RIGHT'}
        }));

        picks.appendChild(L); picks.appendChild(R);
        card.appendChild(picks);
        list.appendChild(card);
      });
    }else{
      list.innerHTML='<div class="pill">No matchups yet.</div>';
    }
    h2hWrap.appendChild(list);
    left.appendChild(h2hWrap);

    const mkWrap=document.createElement('div'); mkWrap.className='card';
    mkWrap.innerHTML='<div class="sectionTitle">Overall Markets</div>';
    const mkts=document.createElement('div'); mkts.className='mkts';

    (sec.overall||[]).forEach(m=>{
      const box=document.createElement('div'); box.className='mkt';
      const top=document.createElement('div'); top.className='mTop';
      top.innerHTML='<div class="lbl">'+esc(m.label||m.type||'Market')+'</div><div class="small">'+esc((m.status||'open').toUpperCase())+'</div>';
      box.appendChild(top);

      const btns=document.createElement('div'); btns.className='mBtns';
      (m.selections||[]).forEach(s=>{
        const b=document.createElement('button'); b.className='sel'; b.type='button';
        b.textContent = s.label+' — '+s.odds;
        b.onclick=()=> addPick({key:'mkt:'+ (m.id ?? ('M'+Math.random().toString(36).slice(2,7))) +':'+ (s.id ?? ('S'+Math.random().toString(36).slice(2,6))), label:m.label+': '+s.label, odds:+s.odds, kind:'MKT', meta:{marketId:m.id??null,selId:s.id??null}});
        btns.appendChild(b);
      });
      box.appendChild(btns);
      mkts.appendChild(box);
    });

    if(!(sec.overall||[]).length){
      const empty=document.createElement('div'); empty.className='pill'; empty.textContent='No markets yet.';
      mkts.appendChild(empty);
    }
    mkWrap.appendChild(mkts);
    left.appendChild(mkWrap);
  }

  function paintBonus(){
    const sec = data.sections?.bonus || {overall:[]};
    const card=document.createElement('div'); card.className='card';
    card.innerHTML='<div class="sectionTitle">Bonus Hunt — Predictions</div>';
    const nameRow=document.createElement('div'); nameRow.className='row'; nameRow.style.marginBottom='8px';
    nameRow.innerHTML='<span class="pill">Display name</span><input id="bhName" class="inp" placeholder="(shown on leaderboard)" style="flex:1;min-width:220px" value="'+esc(player.username)+'">';
    card.appendChild(nameRow);

    (sec.overall||[]).forEach(m=>{
      const box=document.createElement('div'); box.className='mkt';
      const top=document.createElement('div'); top.className='mTop';
      top.innerHTML='<div class="lbl">'+esc(m.label||m.type)+'</div><div class="small">Prize: '+(m.prize||0)+' LBX</div>';
      box.appendChild(top);

      if(m.type==='NUMERIC_GUESS'){
        const row=document.createElement('div'); row.className='guessBox';
        row.innerHTML='<input class="inp" type="number" step="0.01" placeholder="Your number guess"><button class="btn ok" type="button">Submit Guess</button>';
        const inp=$('input',row), btn=$('button',row);
        btn.onclick=()=>{
          const name=$('#bhName').value.trim()||player.username||'Player';
          const guess=(+inp.value);
          if(isNaN(guess)){ alert('Enter a number'); return; }
          storeBHEntry(m.id,{kind:'NUM',name,guess});
          inp.value=''; alert('Submitted!');
        };
        box.appendChild(row);
      }else if(m.type==='TEXT_GUESS'){
        const row=document.createElement('div'); row.className='guessBox';
        row.style.gridTemplateColumns='1fr auto';
        row.innerHTML='<input class="inp" placeholder="Your answer (game name)"><button class="btn ok" type="button">Submit Guess</button>';
        const inp=$('input',row), btn=$('button',row);
        btn.onclick=()=>{
          const name=$('#bhName').value.trim()||player.username||'Player';
          const guess=(inp.value||'').trim();
          if(!guess){ alert('Enter a guess'); return; }
          storeBHEntry(m.id,{kind:'TEXT',name,guess});
          inp.value=''; alert('Submitted!');
        };
        box.appendChild(row);
      }else{
        const p=document.createElement('div'); p.className='small'; p.textContent='(This prediction is managed by admin.)';
        box.appendChild(p);
      }
      card.appendChild(box);
    });

    if(!(sec.overall||[]).length){
      card.innerHTML += '<div class="pill">No predictions configured.</div>';
    }
    left.appendChild(card);
  }
  function storeBHEntry(marketId, payload){
    const key='sb:entries:bonus';
    const arr=sget(key)||[];
    arr.push({id:'E'+Math.random().toString(36).slice(2,8).toUpperCase(),marketId,...payload,userId:player.userId,ts:Date.now()});
    sset(key,arr);
  }

  /* ------------ Slip / Bets / Wallet ------------- */
  let slip={type:'single',items:[],multiStake:10};
  const slList=$('#slList'), sumStake=$('#sumStake'), sumReturn=$('#sumReturn'), multiBox=$('#multiBox'), multiStake=$('#multiStake');

  $$('input[name="mode"]').forEach(r=>{
    r.addEventListener('change',()=>{
      slip.type=r.value;
      multiBox.style.display=(slip.type==='multi')?'flex':'none';
      recalc(); paintSlip();
    });
  });
  multiStake.addEventListener('input',()=>{ slip.multiStake=+multiStake.value||0; recalc(); });

  function delPick(i){ slip.items.splice(i,1); paintSlip(); recalc(); }
  function recalc(){
    if(slip.type==='single'){
      const tStake = slip.items.reduce((a,x)=>a + (+x.stake||0), 0);
      const tRet   = slip.items.reduce((a,x)=>a + ((+x.stake||0) * (+x.odds||0)), 0);
      sumStake.textContent = tStake.toFixed(2);
      sumReturn.textContent= tRet.toFixed(2);
    }else{
      const prod = slip.items.reduce((a,x)=> a*(+x.odds||1), 1);
      const st = +slip.multiStake||0;
      sumStake.textContent  = st.toFixed(2);
      sumReturn.textContent = (st*prod).toFixed(2);
    }
  }
  function paintSlip(){
    slList.innerHTML='';
    slip.items.forEach((it,i)=>{
      const div=document.createElement('div'); div.className='ticket';
      const top=document.createElement('div'); top.className='top';
      top.innerHTML = '<div>'+esc(it.label)+'</div><div class="odds">'+esc(it.odds)+'</div>';
      div.appendChild(top);
      if(slip.type==='single'){
        const row=document.createElement('div'); row.className='row'; row.style.marginTop='6px';
        row.innerHTML = '<span class="small">Stake (LBX)</span><input class="inp stk" type="number" step="1" min="0" value="'+esc(it.stake)+'">';
        $('input',row).addEventListener('input',e=>{ it.stake=+e.target.value||0; recalc(); });
        div.appendChild(row);
      }
      const tools=document.createElement('div'); tools.className='row'; tools.style.marginTop='6px';
      const rm=document.createElement('button'); rm.className='btn warn'; rm.type='button'; rm.textContent='Remove'; rm.onclick=()=>delPick(i);
      tools.appendChild(rm); div.appendChild(tools);
      slList.appendChild(div);
    });
  }
  document.getElementById('btnClear').addEventListener('click',()=>{ slip.items=[]; paintSlip(); recalc(); });

  document.getElementById('btnPlace').addEventListener('click', ()=>{
    if(!slip.items.length){ alert('No selections.'); return; }
    if(mode==='bonus'){ alert('Bonus Hunt guesses are on the Bonus Hunt tab.'); return; }

    const cost = (slip.type==='single')
      ? slip.items.reduce((a,x)=>a+(+x.stake||0),0)
      : (+slip.multiStake||0);

    if(player.lbx < cost){
      alert('Insufficient LBX. Balance: '+player.lbx.toFixed(0));
      return;
    }

    const potential = +sumReturn.textContent;
    const ticket = {
      ts:Date.now(), mode:slip.type, stake:cost, potential,
      legs: slip.items.map(x=>({label:x.label,odds:+x.odds,kind:x.kind,meta:x.meta||{}})),
      status:'Pending', src:mode
    };

    player.lbx = Math.max(0, (player.lbx - cost));
    sset(K_PRO, player);
    refreshPlayerUI();

    const list=getBets(); list.push(ticket); putBets(list);

    alert('Bet placed!'); slip.items=[]; paintSlip(); recalc();
  });

  /* ------------ Boot ------------- */
  (async function init(){
    player = await ensurePlayer();
    refreshPlayerUI();
    await syncBalance();      // keep player card in sync with header
    setTab('battleground');
  })();

  $$('.tab').forEach(t=> t.addEventListener('click',()=> setTab(t.dataset.mode)));
})();
</script>
</body>
</html>
