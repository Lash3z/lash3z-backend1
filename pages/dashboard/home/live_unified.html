<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Unified Live — BG / PVP / Bonus Hunt</title>
<style>
:root{--bg:#060b0d;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;--line:rgba(0,255,255,.18);--teal:#00ffff}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
h1{margin:16px 0 8px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
.wrap{max-width:1300px;margin:0 auto;padding:0 16px 48px}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1720;color:#cfffff;cursor:pointer}
.tab.active{border-color:#00ffff88;box-shadow:0 0 14px #00ffff33}
.list{display:grid;gap:12px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0c1216}
.sides{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.slot{display:grid;grid-template-columns:48px 1fr;gap:8px;align-items:center}
.slot img{width:48px;height:48px;border-radius:10px;object-fit:cover;background:#071017;border:1px solid rgba(255,255,255,.06)}
.vs{opacity:.7}
.small{font-size:12px;color:#9fd0d6}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1>Unified Live</h1>
    <div class="tabs">
      <button class="tab" data-mode="bg">Battleground</button>
      <button class="tab" data-mode="pvp">PVP</button>
      <button class="tab" data-mode="bonus">Bonus Hunt</button>
    </div>
    <span id="badgeMode" class="pill">—</span>
    <span id="badgeTime" class="pill">Live @ —</span>
  </div>

  <div class="card"><div id="list" class="list"><div class="item small">No data yet.</div></div></div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const up=s=>String(s||'').trim().toUpperCase();
  const sget=(k,d=null)=>{ try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(_){return d;} };

  function slotImgFrom(title){
    const DEF="/assets/slot_images/mateslots_logo.png";
    const special={"rip city":"rip_city","gates of olympus":"gates_of_olympus","gates":"gates_of_olympus","starlight princess":"starlight_princess"};
    if(!title) return DEF;
    let s=String(title).toLowerCase().trim(); if(special[s]) s=special[s];
    s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/&/g,'and').replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
    return `/assets/slot_images/${s||'mateslots_logo'}.png`;
  }

  let mode='bg', last=0;

  async function readBG(){
    try{ const r=await fetch('/api/battleground/live',{credentials:'include'}); if(r.ok){ const j=await r.json(); if(j&&j.builder) return j.builder; } }catch(_){}
    return sget('bg:builder:battleground') || sget('battleground:live') || { matches:[], lastUpdated:0 };
  }
  function readPVP(){ return sget('pvp:live') || { rounds:[], flat:[], lastUpdated:0, title:'PVP' }; }
  async function readBonus(){
    try{ const r=await fetch('/api/bonus-hunt/live',{credentials:'include'}); if(r.ok){ const j=await r.json(); if(j&&j.builder) return j.builder; } }catch(_){}
    return sget('bh:live') || sget('bonus:builder') || { games:[], lastUpdated:0 };
  }

  function setImage(img, manual, title){
    img.onerror=null;
    img.src = manual || slotImgFrom(title);
    img.onerror = ()=>{ img.src='/assets/slot_images/mateslots_logo.png'; };
  }

  function paintBG(list,data){
    const matches = Array.isArray(data.matches)?data.matches:[]; if(!matches.length){ list.innerHTML='<div class="item small">No matchups yet.</div>'; return; }
    list.innerHTML='';
    matches.forEach(m=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`<div class="sides">
        <div class="slot"><img><div><b>${up(m.leftTitle||m.left?.name||'')}</b><div class="small">${m.leftProv||m.left?.game||''}</div></div></div>
        <div class="vs">VS</div>
        <div class="slot"><img><div><b>${up(m.rightTitle||m.right?.name||'')}</b><div class="small">${m.rightProv||m.right?.game||''}</div></div></div>
      </div>`;
      const imgs=div.querySelectorAll('img');
      if(imgs[0]) setImage(imgs[0], m.leftImg,  m.leftProv);
      if(imgs[1]) setImage(imgs[1], m.rightImg, m.rightProv);
      list.appendChild(div);
    });
  }

  function paintPVP(list,data){
    const show = (data.rounds||[]).slice().reverse().find(r=>r.matches?.length) || data.rounds?.[0];
    const matches = show?.matches || data.flat || [];
    if(!matches.length){ list.innerHTML = '<div class="item small">No matchups yet.</div>'; return; }
    list.innerHTML='';
    matches.forEach(m=>{
      const lName = m.left?.username || m.left || '';
      const rName = m.right?.username || m.right || '';
      const lProv = m.left?.game || m.leftProv || '';
      const rProv = m.right?.game || m.rightProv || '';
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`<div class="sides">
        <div class="slot"><img><div><b>${up(lName)}</b><div class="small">${lProv}</div></div></div>
        <div class="vs">VS</div>
        <div class="slot"><img><div><b>${up(rName)}</b><div class="small">${rProv}</div></div></div>
      </div>
      <div class="small">${data.title||'PVP'} — ${show?.name||''} ${m.winner?`· Winner: ${m.winner==='L'?'LEFT':'RIGHT'}`:''}</div>`;
      const imgs=div.querySelectorAll('img');
      if(imgs[0]) setImage(imgs[0], m.leftImg,  lProv);
      if(imgs[1]) setImage(imgs[1], m.rightImg, rProv);
      list.appendChild(div);
    });
  }

  function paintBonus(list,data){
    const games = Array.isArray(data.games)?data.games:[]; if(!games.length){ list.innerHTML='<div class="item small">No games yet.</div>'; return; }
    list.innerHTML='';
    games.forEach(g=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`<div class="sides"><div class="slot"><img><div><b>${g.title||g.name||''}</b><div class="small">${g.provider||''}</div></div></div><div></div><div></div></div>`;
      const img=div.querySelector('img'); if(img) setImage(img, g.img||g.logo, g.title||g.name);
      list.appendChild(div);
    });
  }

  async function paint(){
    const list=$("#list"), modeBadge=$("#badgeMode"), time=$("#badgeTime");
    if(mode==='bg'){ modeBadge.textContent='BATTLEGROUND — BG'; const d=await readBG(); last=d.lastUpdated||0; time.textContent='Live @ '+(last?new Date(last).toLocaleTimeString():'—'); paintBG(list,d); }
    else if(mode==='pvp'){ modeBadge.textContent='PVP — Knockout'; const d=readPVP(); last=d.lastUpdated||d.ts||0; time.textContent='Live @ '+(last?new Date(last).toLocaleTimeString():'—'); paintPVP(list,d); }
    else { modeBadge.textContent='BONUS HUNT'; const d=await readBonus(); last=d.lastUpdated||d.updated||0; time.textContent='Live @ '+(last?new Date(last).toLocaleTimeString():'—'); paintBonus(list,d); }
  }

  function setMode(m){ mode=m; $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.mode===m)); paint(); }
  document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=>setMode(t.dataset.mode)));
  window.addEventListener("storage",(e)=>{ if((mode==='pvp' && e.key==='pvp:live') || (mode==='bg' && (e.key==='bg:builder:battleground'||e.key==='battleground:live')) || (mode==='bonus' && (e.key==='bh:live'||e.key==='bonus:builder'))) paint(); });
  setInterval(paint, 1500);

  setMode('bg');
})();
</script>
</body>
</html>
