<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battleground — Prediction Form</title>
<style>
  :root{
    --ink:#eaf7ff; --muted:#8fbfc4; --teal:#00ffff; --gold:#ffb42d;
    --bg:#050a0c; --panel:rgba(5,10,12,.78); --line:rgba(0,255,255,.16);
    --ok:#12f3d6; --danger:#ff5a73;
  }
  html,body{margin:0;height:100%;background:#000 url("/assets/media/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:16px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(5,10,12,.70),rgba(5,10,12,.78));box-shadow:0 8px 30px rgba(0,0,0,.45)}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:22px;letter-spacing:.02em;text-shadow:0 0 12px rgba(0,255,255,.35)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1f21;color:#cfffff;font-weight:800}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .controls input{background:#061417;border:1px solid var(--line);border-radius:8px;color:var(--ink);padding:8px 10px;outline:none}
  .hint{color:var(--muted);font-size:12px}
  .match{display:grid;grid-template-columns:1fr 52px 60px 52px 1fr;gap:14px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:rgba(0,0,0,.35)}
  .match + .match{margin-top:12px}
  .desc{min-width:0}
  .name{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .prov{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .thumb{width:52px;height:68px;border:1px solid var(--line);border-radius:8px;background:#000;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .vs{font-weight:900;text-align:center;opacity:.9;display:flex;flex-direction:column;gap:6px;align-items:center}
  .badge{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#0b1f21;color:#9ff8ff}
  .pick-left{grid-column:1 / span 2}.pick-right{grid-column:4 / span 2}
  .pick{display:grid;gap:10px;align-items:center}
  .pick-left .pick{grid-template-columns:1fr 52px}
  .pick-right .pick{grid-template-columns:52px 1fr}
  .pick-left .desc{text-align:right}
  .pick-right .desc{text-align:left}
  .card{border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px;transition:.15s all}
  .card.active{outline:2px solid var(--ok);box-shadow:0 0 0 3px rgba(18,243,214,.15) inset}
  .card.locked{opacity:.5;pointer-events:none}
  .section{margin-top:18px}
  .scoreGrid{display:grid;grid-template-columns:1fr 52px 60px 52px 1fr;gap:14px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:rgba(0,0,0,.35)}
  .scoreTitle{grid-column:1 / -1;font-weight:900;margin-bottom:4px}
  .scoreInput{display:flex;gap:8px;align-items:center}
  .scoreInput input{width:70px;text-align:center;font-weight:900;background:#061417;border:1px solid var(--line);border-radius:8px;color:var(--ink);padding:8px}
  .lblL{justify-self:end}.lblR{justify-self:start}.colon{font-weight:900;text-align:center;opacity:.85}
  .hintRow{grid-column:1 / -1;color:var(--muted);font-size:12px;margin-top:4px}
  .err{color:var(--danger);font-size:12px;margin-top:4px}
  .submitbar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:16px}
  button{background:#0b1f21;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#0ef,#12f3d6);-webkit-background-clip:text;background-clip:text;color:transparent;border-color:var(--ok)}
  button[disabled]{opacity:.4;cursor:not-allowed}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--line);border-radius:8px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.2s all}
  .toast.on{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
  <!-- USER HEADER (drop this right after <body>) -->
<div class="userbar" id="userBar">
  <div class="ub-left">
    <span class="ub-hello">Hello,</span>
    <span id="ubName" class="ub-name">Guest</span>
  </div>
  <div class="ub-right">
    <span class="ub-badge">LBX <b id="ubBal">0</b></span>
  </div>
</div>

<style>
  .userbar{
    max-width:1100px; margin:12px auto 8px; padding:8px 12px;
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid rgba(255,255,255,.10); border-radius:12px;
    background:rgba(0,0,0,.25); backdrop-filter: blur(6px);
  }
  .ub-hello{ font-size:12px; color:#9fd0d6; margin-right:6px }
  .ub-name{ font-weight:900; color:#ffe39a }        /* light yellow (readable on dark) */
  .ub-badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-weight:800;
    background:#2a2310; color:#ffe39a; border:1px solid #8c6926;  /* “signup” gold vibe */
  }
  /* keep it tucked on small screens */
  @media (max-width:520px){
    .userbar{ margin:8px 8px 4px; }
  }
</style>

<script>
(function(){
  "use strict";
  const $  = s => document.querySelector(s);
  const up = s => String(s||"").trim().toUpperCase();
  const sget = (k,def=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(_){ return def; } };

  // Prefer current URL ?viewer=NAME, else use your existing session/profile keys
  function pickUser(){
    const qp = new URLSearchParams(location.search).get("viewer");
    if (qp && qp.trim()) return up(qp);
    const sess = sget("l3z:session");           // { user, issuedAt, expiresAt }
    if (sess && sess.user) return up(sess.user);
    const prof = sget("l3z:user");              // { username, ... }
    if (prof && prof.username) return up(prof.username);
    const legacy = localStorage.getItem("user:username");
    if (legacy) return up(legacy);
    const last = sget("lash3z_last_user");
    if (last) return up(last);
    return "";
  }

  async function refresh(){
    const name = pickUser() || "GUEST";
    $("#ubName").textContent = name;

    // Ask server first
    try{
      const r = await fetch("/api/wallet/me?viewer="+encodeURIComponent(name), { credentials:"include" });
      if(!r.ok) throw 0;
      const j = await r.json();
      const bal = (j && j.wallet && typeof j.wallet.balance==="number") ? j.wallet.balance : 0;
      $("#ubBal").textContent = Math.floor(bal);
      return;
    }catch(_){ /* fall through to local */ }

    // Fallback to local wallet mirror if offline / server not set
    const w = sget("lbx:wallet:"+name) || { balance: 0 };
    $("#ubBal").textContent = Math.floor(Number(w.balance||0));
  }

  // react to login/signup changes in other tabs
  window.addEventListener("storage", (e)=>{
    if(["l3z:session","l3z:user","user:username","lash3z_last_user"].includes(e.key)) refresh();
  });

  refresh();
})();
</script>

<div class="wrap">
  <div class="topbar"><h1>Battleground — Prediction Form</h1><div class="pill" id="evtInfo">—</div></div>
  <div class="controls">
    <label>Player&nbsp;Name <input id="user" placeholder="USERNAME"/></label>
    <span class="hint">Pick LEFT or RIGHT for each matchup. Bonus: predict the exact final score.</span>
  </div>
  <div id="list"></div>

  <div class="section">
    <div class="scoreGrid">
      <div class="scoreTitle">Final Score</div>
      <div class="lblL"><span id="leftLbl">Left</span></div>
      <div class="scoreInput" style="grid-column:2"><input id="scoreL" type="number" min="0" step="1" value="0"/></div>
      <div class="colon">:</div>
      <div class="scoreInput" style="grid-column:4"><input id="scoreR" type="number" min="0" step="1" value="0"/></div>
      <div class="lblR"><span id="rightLbl">Right</span></div>
      <div class="hintRow" id="scoreHint">Must add up to 3 (e.g., 2–1 or 3–0).</div>
    </div>
    <div class="err" id="scoreErr"></div>
  </div>

  <div class="submitbar">
    <button id="clearBtn">Clear</button>
    <button id="submitBtn" class="primary" disabled>Submit Predictions</button>
  </div>
</div>
<div class="toast" id="toast">Saved.</div>

<script>
(() => {
  "use strict";
  const K_PUBLISHED='sb:markets:battleground';
  const K_BUILDER='bg:builder:battleground';
  const K_BETS='lash3z_bets';                // legacy per-match entries (kept)
  const MYBETS_KEY = u => 'sb:mybets:'+u;    // compact “My Bets” feed

  const $=s=>document.querySelector(s);
  const listEl=$('#list'), userEl=$('#user'), evtInfoEl=$('#evtInfo');
  const scoreLEl=$('#scoreL'), scoreREl=$('#scoreR'), scoreErrEl=$('#scoreErr');
  const leftLblEl=$('#leftLbl'), rightLblEl=$('#rightLbl'), scoreHintEl=$('#scoreHint');
  const submitBtn=$('#submitBtn'), clearBtn=$('#clearBtn'), toast=$('.toast');

  let eventId='battleground:'+new Date().toISOString().slice(0,10);
  let eventTitle='BATTLEGROUND';
  let matchups=[]; let picks=new Map();
  let leftSeriesName='Left', rightSeriesName='Right';
  let seriesTotal=3;

  const read=k=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{return null}};
  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function normalizeFromPublished(o){
    if(!o||typeof o!=='object') return null;
    const m=Array.isArray(o.h2h)?o.h2h:[];
    return {
      source:'published',
      lastUpdated:Number(o.lastUpdated||o.ts||0)||0,
      eventId:o.eventId||eventId,
      title:o.title||eventTitle,
      matchups:m.map((x,i)=>({
        id:x.id||('M'+(i+1)),
        left:{title:x.left?.title||x.leftTitle||'LEFT', provider:x.left?.provider||x.leftProv||'', img:x.left?.img||x.leftImg||''},
        right:{title:x.right?.title||x.rightTitle||'RIGHT', provider:x.right?.provider||x.rightProv||'', img:x.right?.img||x.rightImg||''},
        status:(x.status||'OPEN').toUpperCase()
      })),
      seriesTotal:Number(o.seriesTotal||o.bestOf||3)
    };
  }
  function normalizeFromBuilder(o){
    if(!o||typeof o!=='object') return null;
    const gById=new Map((o.games||[]).map(g=>[g.id,g]));
    const ms=Array.isArray(o.matches)?o.matches:[];
    const M=ms.map((m,i)=>{
      const L=gById.get(m.leftId||m.leftGameId)||{};
      const R=gById.get(m.rightId||m.rightGameId)||{};
      return {
        id:m.id||('M'+(i+1)),
        left:{ title:L.title||L.name||m.leftTitle||'LEFT', provider:L.provider||m.leftProv||'', img:L.imageUrl||L.image||m.leftImg||'' },
        right:{ title:R.title||R.name||m.rightTitle||'RIGHT', provider:R.provider||m.rightProv||'', img:R.imageUrl||R.image||m.rightImg||'' },
        status:(m.status||'OPEN').toUpperCase()
      };
    });
    return { source:'builder', lastUpdated:Number(o.lastUpdated||0)||0, eventId:o.eventId||eventId, title:o.title||eventTitle, matchups:M, seriesTotal:Number(o.seriesTotal||o.bestOf||3) };
  }
  function chooseDataset(){
    const pub=normalizeFromPublished(read(K_PUBLISHED));
    const bld=normalizeFromBuilder(read(K_BUILDER));
    const pc=pub?.matchups?.length||0, bc=bld?.matchups?.length||0;
    if(bld && bc && bc>=pc) return bld;
    if(pub && pc) return pub;
    return bld || pub || {source:'none',eventId,title:eventTitle,matchups:[],seriesTotal:3,lastUpdated:0};
  }

  function loadData(){
    const norm=chooseDataset();
    eventId=norm.eventId||eventId;
    eventTitle=(norm.title||'BATTLEGROUND').toString().toUpperCase();
    matchups=[...(norm.matchups||[])];
    seriesTotal=Number(norm.seriesTotal||3)||3;
    const when = norm.lastUpdated ? (' @ '+new Date(norm.lastUpdated).toLocaleString()) : '';
    evtInfoEl.textContent=`${eventTitle} — ${eventId}  [${norm.source.toUpperCase()}${when}]`;
    if(matchups.length){
      leftSeriesName=matchups[0].left?.title||'Left';
      rightSeriesName=matchups[0].right?.title||'Right';
      leftLblEl.textContent=leftSeriesName;
      rightLblEl.textContent=rightSeriesName;
    }
    scoreLEl.max=seriesTotal; scoreREl.max=seriesTotal;
    scoreHintEl.textContent=`Must add up to ${seriesTotal} (e.g., ${seriesTotal-1}–1 or ${seriesTotal}–0).`;
  }

  function render(){
    const html=matchups.map(m=>`
      <div class="match" data-id="${esc(m.id)}">
        <div class="pick-left">
          <div class="card pick ${picks.get(m.id)==='left'?'active':''} ${m.status!=='OPEN'?'locked':''}" data-pick="left">
            <div class="desc"><div class="name">${esc(m.left.title||'—')}</div><div class="prov">${esc(m.left.provider||'')}</div></div>
            <div class="thumb">${m.left.img?`<img src="${esc(m.left.img)}" alt="">`:''}</div>
          </div>
        </div>
        <div class="vs">VS <span class="badge">${m.status}</span></div>
        <div class="pick-right">
          <div class="card pick ${picks.get(m.id)==='right'?'active':''} ${m.status!=='OPEN'?'locked':''}" data-pick="right">
            <div class="thumb">${m.right.img?`<img src="${esc(m.right.img)}" alt="">`:''}</div>
            <div class="desc"><div class="name">${esc(m.right.title||'—')}</div><div class="prov">${esc(m.right.provider||'')}</div></div>
          </div>
        </div>
      </div>`).join('');
    $('#list').innerHTML=html||`<div class="hint">No published matchups yet. Hit “Push → Prediction + Live + Bets” in BG Admin.</div>`;
    $('#list').querySelectorAll('.match').forEach(row=>{
      const id=row.getAttribute('data-id');
      row.querySelectorAll('.card.pick').forEach(card=>{
        card.addEventListener('click',()=>{
          if(card.classList.contains('locked'))return;
          picks.set(id,card.getAttribute('data-pick'));
          row.querySelectorAll('.card.pick').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
          validate();
        });
      });
    });
    validate();
  }

  function validate(){
    const uname=(userEl.value||'').trim().toUpperCase();
    const allPicked=matchups.length && matchups.every(m=>['left','right'].includes(picks.get(m.id)));
    const sl=Number(scoreLEl.value||0), sr=Number(scoreREl.value||0);
    const sumOk=(sl+sr)===seriesTotal;
    const within=sl>=0 && sr>=0 && sl<=seriesTotal && sr<=seriesTotal;
    scoreErrEl.textContent=(sumOk&&within)?'':`Final score must add up to ${seriesTotal}.`;
    submitBtn.disabled=!(uname && allPicked && sumOk && within);
  }

  // legacy per-match write (kept, no UI change)
  function upsertBets(records){
    const now=Date.now();
    const existing=(()=>{try{return JSON.parse(localStorage.getItem(K_BETS)||'[]')}catch{return []}})();
    const uname=(userEl.value||'').trim().toUpperCase();
    const filtered=existing.filter(r=>!(r.mode==='battleground' && r.user===uname && r.eventId===eventId && (r.type==='prediction'||r.type==='series_score')));
    const next=filtered.concat(records.map(r=>({ts:now,...r})));
    localStorage.setItem(K_BETS,JSON.stringify(next));
  }

  // NEW: minimal “My Bets” record for display
  function writeMyBets(){
    const uname=(userEl.value||'').trim().toUpperCase();
    const sl=Number(scoreLEl.value||0), sr=Number(scoreREl.value||0);
    const rec={
      ts: Date.now(),
      user: uname,
      eventId,
      eventTitle,
      picks: matchups.map(m=>{
        const side=picks.get(m.id);
        const pickName = side==='left' ? (m.left.title||'LEFT') : (m.right.title||'RIGHT');
        return { matchId:m.id, left:m.left.title||'LEFT', right:m.right.title||'RIGHT', pick:side, pickName };
      }),
      final: { leftName:leftSeriesName, rightName:rightSeriesName, left:sl, right:sr, total:seriesTotal }
    };
    const k=MYBETS_KEY(uname);
    let arr=[]; try{ arr=JSON.parse(localStorage.getItem(k)||'[]')||[]; }catch{}
    arr.push(rec);
    localStorage.setItem(k, JSON.stringify(arr.slice(-20)));
  }

  function submit(){
    const uname=(userEl.value||'').trim().toUpperCase();
    const recs=[];
    matchups.forEach(m=>{
      const pick=picks.get(m.id);
      const pickName=pick==='left'?(m.left.title||'LEFT'):(m.right.title||'RIGHT');
      recs.push({mode:'battleground',type:'prediction',user:uname,eventId,matchId:m.id,pick,pickName});
    });
    const sl=Number(scoreLEl.value||0), sr=Number(scoreREl.value||0);
    recs.push({mode:'battleground',type:'series_score',user:uname,eventId,leftName:leftSeriesName,rightName:rightSeriesName,left:sl,right:sr,total:seriesTotal});
    upsertBets(recs);     // keep legacy feed
    writeMyBets();        // new compact feed
    toast.textContent=`Saved ${recs.length-1} picks + final score for ${uname}.`;
    toast.classList.add('on'); setTimeout(()=>toast.classList.remove('on'),1400);
  }

  function clearAll(){ picks.clear(); scoreLEl.value=0; scoreREl.value=0; render(); }

  // init
  userEl.value=(localStorage.getItem('lash3z_last_user')||'').toUpperCase();
  userEl.addEventListener('input',()=>{localStorage.setItem('lash3z_last_user',(userEl.value||'').toUpperCase()); validate();});
  scoreLEl.addEventListener('input',validate);
  scoreREl.addEventListener('input',validate);
  submitBtn.addEventListener('click',submit);
  clearBtn.addEventListener('click',clearAll);

  loadData(); render();
  window.addEventListener('storage',e=>{ if([K_PUBLISHED,K_BUILDER].includes(e.key)){ loadData(); render(); } });
})();
</script>
</body>
</html>
