<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Bets — LASH3Z</title>
<meta name="description" content="Player predictions saved from the Battleground Prediction Form."/>
<style>
  :root{ --bg:#0b0e13; --panel:#12151c; --ink:#e8ecf3; --muted:#9fb3c5; --line:rgba(0,255,255,.18); --teal:#00ffff; }
  *{box-sizing:border-box}
  html,body{ margin:0; background:#000 url("/assets/media/BG_page.png") center/cover fixed no-repeat; color:var(--ink); font-family:Segoe UI,system-ui,Arial,sans-serif }
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .topbar{height:64px;background:rgba(0,0,0,.7);backdrop-filter:saturate(140%) blur(6px);border:1px solid var(--line);border-radius:14px;display:flex;align-items:center;justify-content:space-between;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{margin:0;font-size:18px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0a1016;color:#cfe;font-weight:800}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
  .tab-btn{appearance:none;background:none;border:none;padding:0;cursor:pointer}
  .pill.on{background:rgba(0,255,255,.08);border-color:var(--teal);box-shadow:0 0 0 1px rgba(0,255,255,.1) inset}
  .tab-btn:focus-visible{outline:2px solid var(--teal);outline-offset:2px;border-radius:999px}
  .tab-panel{display:none}
  .tab-panel[aria-hidden="false"]{display:block}
  .list{margin-top:16px;display:flex;flex-direction:column;gap:12px}
  .card{background:linear-gradient(180deg,#0e1319,#0b1016);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
  .head .title{font-weight:900}
  .body{padding:10px 14px;display:flex;flex-direction:column;gap:6px}
  .row{display:flex;justify-content:space-between;gap:10px}
  .muted{color:var(--muted)}
  .empty{margin:16px 0;border:1px dashed var(--line);border-radius:12px;padding:16px;text-align:center;color:#cfe;background:#0f151c}
  .small{font-size:12px}
  .toolbar{display:flex;align-items:center;gap:8px;margin:12px 0}
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1a1f;color:#cfe;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(1.06)}
  .search{flex:1;min-width:180px;background:#0f141b;border:1px solid var(--line);border-radius:10px;color:#e8ecf3;padding:9px 12px}
</style>
</head>
<body>
  <!-- USER HEADER (drop this right after <body>) -->
<div class="userbar" id="userBar">
  <div class="ub-left">
    <span class="ub-hello">Hello,</span>
    <span id="ubName" class="ub-name">Guest</span>
  </div>
  <div class="ub-right">
    <span class="ub-badge">LBX <b id="ubBal">0</b></span>
  </div>
</div>

<style>
  .userbar{
    max-width:1100px; margin:12px auto 8px; padding:8px 12px;
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid rgba(255,255,255,.10); border-radius:12px;
    background:rgba(0,0,0,.25); backdrop-filter: blur(6px);
  }
  .ub-hello{ font-size:12px; color:#9fd0d6; margin-right:6px }
  .ub-name{ font-weight:900; color:#ffe39a }
  .ub-badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-weight:800;
    background:#2a2310; color:#ffe39a; border:1px solid #8c6926;
  }
  @media (max-width:520px){
    .userbar{ margin:8px 8px 4px; }
  }
</style>

<!-- ===== Unified viewer helper (prevents “last-write-wins”) ===== -->
<script>
(function(){
  if (window.l3zGetViewer) return; // reuse if already defined elsewhere
  const sget=(k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
  const pickName=()=>{
    const qp=new URLSearchParams(location.search).get('viewer'); if(qp) return qp.trim().toUpperCase();
    const sess=sget('l3z:session'); if(sess?.user) return String(sess.user).toUpperCase();
    const prof=sget('l3z:user'); if(prof?.username) return String(prof.username).toUpperCase();
    const lg=localStorage.getItem('user:username'); if(lg) return String(lg).toUpperCase();
    const last=sget('lash3z_last_user'); if(last) return String(last).toUpperCase();
    return 'PLAYER';
  };
  async function fetchBalance(name){
    try{
      const r=await fetch('/api/viewer/me',{credentials:'include',cache:'no-store'});
      if(r.ok){ const j=await r.json();
        const u=(j?.username||name||'PLAYER').toUpperCase();
        if (j?.wallet && typeof j.wallet.balance==='number') return {username:u, balance:j.wallet.balance};
        name=u;
      }
    }catch(_){}
    try{
      const r=await fetch('/api/wallet/balance',{credentials:'include',cache:'no-store'});
      if(r.ok){ const j=await r.json(); if(typeof j.balance==='number') return {username:name, balance:j.balance}; }
    }catch(_){}
    try{
      const r=await fetch('/api/wallet/me?viewer='+encodeURIComponent(name),{credentials:'include',cache:'no-store'});
      if(r.ok){ const j=await r.json(); if(j?.wallet && typeof j.wallet.balance==='number') return {username:name, balance:j.wallet.balance}; }
    }catch(_){}
    const w = sget('lbx:wallet:'+name) || { balance:0 };
    return {username:name, balance:Number(w.balance)||0};
  }
  let _memo=null;
  window.l3zGetViewer = async function(){
    if(_memo) return _memo;
    const name = pickName();
    _memo = fetchBalance(name).then(x=>({ username:(x.username||name).toUpperCase(), balance:Math.max(0, Math.floor(Number(x.balance)||0)) }));
    return _memo;
  };
})();
</script>

<!-- Header fill (uses unified helper + “only upgrade” write) -->
<script>
(function(){
  "use strict";
  const $  = s => document.querySelector(s);
  const onlyUpgradeNumber = (el, value)=>{
    if(!el) return;
    const v = Math.max(0, Math.floor(Number(value)||0));
    const cur = Math.max(0, Math.floor(Number(String(el.textContent).replace(/[^\d.-]/g,''))||0));
    if (cur !== 0 && v === 0) return; // don't downgrade non-zero to 0
    el.textContent = String(v);
  };

  async function refresh(){
    const { username, balance } = await window.l3zGetViewer();
    $("#ubName").textContent = username || "GUEST";
    onlyUpgradeNumber($("#ubBal"), balance);
  }

  window.addEventListener("storage", (e)=>{
    if(["l3z:session","l3z:user","user:username","lash3z_last_user"].includes(e.key)) refresh();
  });

  refresh();
})();
</script>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <img src="/assets/l3z_logo.png" alt="LASH3Z" onerror="this.src='/assets/lash3zbux_pp.png'"
           style="width:36px;height:36px;border-radius:10px;border:1px solid var(--line);object-fit:cover;background:#000">
      <h1>My Bets</h1>
    </div>
    <div id="who" class="pill">—</div>
  </div>

  <div class="tabs" role="tablist" aria-label="Bet categories">
    <button class="tab-btn pill on"   id="tab-battleground" role="tab" aria-selected="true"  aria-controls="panel-battleground" data-tab="battleground">Battleground</button>
    <button class="tab-btn pill"       id="tab-pvp"         role="tab" aria-selected="false" aria-controls="panel-pvp"          data-tab="pvp">PVP</button>
    <button class="tab-btn pill"       id="tab-bonus"       role="tab" aria-selected="false" aria-controls="panel-bonus"        data-tab="bonus">Bonus Hunt</button>
  </div>

  <section id="panel-battleground" class="tab-panel" role="tabpanel" aria-labelledby="tab-battleground" aria-hidden="false">
    <div class="toolbar">
      <input id="q" class="search" placeholder="Filter by event, game, or pick…">
      <button id="refresh" class="btn">Refresh</button>
      <span class="small muted" id="count"></span>
    </div>
    <div id="list" class="list"></div>
  </section>

  <section id="panel-pvp" class="tab-panel" role="tabpanel" aria-labelledby="tab-pvp" aria-hidden="true">
    <div class="card"><div class="head"><div class="title">PVP</div><div class="pill small">Coming soon</div></div><div class="body"><div class="empty">PVP entries and results will appear here.</div></div></div>
  </section>

  <section id="panel-bonus" class="tab-panel" role="tabpanel" aria-labelledby="tab-bonus" aria-hidden="true">
    <div class="card"><div class="head"><div class="title">Bonus Hunt</div><div class="pill small">Coming soon</div></div><div class="body"><div class="empty">Bonus Hunt requests and payouts will appear here.</div></div></div>
  </section>
</div>

<script src="/assets/api-base.js"></script>
<script>
if(!window.__L3Z_MYBETS_INIT__){ window.__L3Z_MYBETS_INIT__ = true;
(function(){
  "use strict";
  const $ = s => document.querySelector(s);
  const esc = s => String(s??'').replace(/[&<>"']/g,m=>m==="&"?"&amp;":m==="<"?"&lt;":m===">"?"&gt;":"&quot;");
  const whoEl=$("#who"), listEl=$("#list"), qEl=$("#q"), countEl=$("#count");

  // Tabs
  const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
  const panels = { battleground:$("#panel-battleground"), pvp:$("#panel-pvp"), bonus:$("#panel-bonus") };
  function setActive(name, user=false){
    tabs.forEach(btn=>{ const on=btn.dataset.tab===name; btn.classList.toggle('on',on); btn.setAttribute('aria-selected',String(on)); btn.tabIndex=on?0:-1; });
    Object.entries(panels).forEach(([k,el])=> el.setAttribute('aria-hidden', String(k!==name)));
    if(user) history.replaceState(null,"","#"+name);
    if(name==="battleground") render();
  }
  document.querySelector('.tabs').addEventListener('keydown', e=>{
    const i = tabs.findIndex(b=>b.classList.contains('on'));
    if(e.key==="ArrowRight"){ e.preventDefault(); setActive(tabs[(i+1)%tabs.length].dataset.tab, true); }
    if(e.key==="ArrowLeft"){  e.preventDefault(); setActive(tabs[(i-1+tabs.length)%tabs.length].dataset.tab, true); }
    if(e.key==="Home"){       e.preventDefault(); setActive(tabs[0].dataset.tab, true); }
    if(e.key==="End"){        e.preventDefault(); setActive(tabs[tabs.length-1].dataset.tab, true); }
  });
  tabs.forEach(btn=> btn.addEventListener("click", ()=> setActive(btn.dataset.tab, true)));
  setActive((location.hash||"").replace(/^#/,"") in panels ? (location.hash||"").slice(1) : "battleground", false);

  // who (use unified helper)
  (async ()=>{
    try{
      const me = await window.l3zGetViewer();
      whoEl.textContent = (me.username||"PLAYER").toUpperCase();
    }catch{ whoEl.textContent = "PLAYER"; }
  })();

  // Fetch + render
  async function fetchBets(){
    const j = await apiFetch("/api/bets/me?limit=200");
    return Array.isArray(j.bets) ? j.bets : [];
  }

  function matchFilter(entry, q){
    if(!q) return true;
    q = q.toLowerCase();
    if((entry.eventId||"").toLowerCase().includes(q)) return true;
    if((entry.eventTitle||"").toLowerCase().includes(q)) return true;
    if(entry.picks){
      for(const p of entry.picks){
        if((p.left||"").toLowerCase().includes(q)) return true;
        if((p.right||"").toLowerCase().includes(q)) return true;
        if((p.pickName||"").toLowerCase().includes(q)) return true;
      }
    }
    return false;
  }

  async function render(){
    if (panels.battleground.getAttribute('aria-hidden') === 'true') return;
    listEl.innerHTML = '<div class="empty">Loading…</div>';
    try{
      const data = (await fetchBets()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      const q = (qEl.value||"").trim().toLowerCase();
      const rows = data.filter(e=>matchFilter(e,q));
      countEl.textContent = rows.length ? (rows.length+" entr"+(rows.length===1?"y":"ies")) : "";
      if(!rows.length){ listEl.innerHTML='<div class="empty">No predictions saved yet.</div>'; return; }

      listEl.innerHTML = rows.map(entry=>{
        const when = new Date((entry.createdAt||Date.now())*1000).toLocaleString();
        const picks = (entry.picks||[]).map(p=>`
          <div class="row">
            <div>${esc(p.left)} vs ${esc(p.right)}</div>
            <div><b>Pick:</b> ${esc(p.pickName||'')}</div>
          </div>`).join("");
        return `
          <article class="card">
            <div class="head">
              <div class="title">${esc(entry.eventTitle||'Battleground')} — <span class="muted">${esc(entry.eventId||'')}</span></div>
              <div class="pill small">${esc(when)}</div>
            </div>
            <div class="body">
              ${picks || '<div class="muted">No matchup picks.</div>'}
            </div>
          </article>`;
      }).join("");
    }catch(e){
      listEl.innerHTML = `<div class="empty">Could not load bets: ${esc(e.body?.error || e.message || "network error")}</div>`;
    }
  }

  document.getElementById("refresh").addEventListener("click", render);
  qEl.addEventListener("input", render);

  render();
})();
}
</script>

<!-- viewer glue v2 (now uses unified helper + no-downgrade writes) -->
<script id="viewer-glue">
(function(){
  const S = (sel) => document.querySelector(sel);
  const SS = (sel) => Array.from(document.querySelectorAll(sel));
  const set = (sel, val) => { const n=S(sel); if(n){ n.textContent = val; n.title = val; }};
  const onlyUpgradeNumber = (el, value)=>{
    if(!el) return;
    const v = Math.max(0, Math.floor(Number(value)||0));
    const cur = Math.max(0, Math.floor(Number(String(el.textContent).replace(/[^\d.-]/g,''))||0));
    if (cur !== 0 && v === 0) return;
    el.textContent = String(v);
  };

  async function loadMe(){
    const me = await window.l3zGetViewer();

    const user = (me.username||'').toUpperCase();
    set('#helloName', user);
    set('#welcomeName', user);
    set('#usernameDisplay', user);
    set('#ubName', user);
    set('#playerName', user);
    set('#who', user);
    if (S('#guestChipLabel')) S('#guestChipLabel').textContent = user;

    const pretty = (Number(me.balance)||0).toFixed(0);
    set('#headerLbx', pretty+' LBX');
    set('#navLbx',    pretty);
    onlyUpgradeNumber(S('#ubBal'), pretty);
    set('#playerBalance', pretty);
    set('#walletBalance', pretty);
    set('#walletBalanceTop', pretty);

    SS('.lbx-pill,.lbx,.pill-lbx').forEach(n=>{
      const m = String(n.textContent||'').match(/\b(\d+)\b/);
      if (m) n.textContent = (n.textContent||'').replace(m[1], pretty);
    });

    // kill any “switch name” buttons if present on this page
    ['#btnSwitch','.btnSwitchName','#switchName','.switch-name','.switchName'].map(S).filter(Boolean).forEach(n=>n.style.display='none');
    SS('button').forEach(b=>{ const t=(b.textContent||'').toLowerCase(); if(t.includes('switch name')) b.style.display='none'; });
  }
  loadMe();
  window.addEventListener('focus', loadMe);
  document.addEventListener('visibilitychange', () => { if(!document.hidden) loadMe(); });
})();
</script>
</body>
</html>
